"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.makeUniqueResourceName = void 0;
const md5_1 = require("./md5");
/**
 * Resources with this ID are hidden from humans
 *
 * They do not appear in the human-readable part of the logical ID,
 * but they are included in the hash calculation.
 */
const HIDDEN_FROM_HUMAN_ID = 'Resource';
/**
* Resources with this ID are complete hidden from the logical ID calculation.
*/
const HIDDEN_ID = 'Default';
const PATH_SEP = '/';
const MAX_LEN = 256;
const HASH_LEN = 8;
function makeUniqueResourceName(components, options) {
    const maxLength = options.maxLength ?? 256;
    const separator = options.separator ?? '';
    const prefix = options.prefix ?? '';
    components = components.filter(x => x !== HIDDEN_ID);
    if (components.length === 0) {
        throw new Error('Unable to calculate a unique resource name for an empty set of components');
    }
    // top-level resources will simply use the `name` as-is if the name is also short enough
    // in order to support transparent migration of ROS templates to the CDK without the
    // need to rename all resources.
    if (components.length === 1) {
        const topLevelResource = prefix + removeNonAllowedSpecialCharacters(components[0], separator, options.allowedSpecialCharacters);
        if (topLevelResource.length <= maxLength) {
            return topLevelResource;
        }
    }
    // Calculate the hash from the full path, included unresolved tokens so the hash value is always unique
    const hash = pathHash(components);
    const human = prefix + removeDupes(components)
        .filter(pathElement => pathElement !== HIDDEN_FROM_HUMAN_ID)
        .map(pathElement => removeNonAllowedSpecialCharacters(pathElement, separator, options.allowedSpecialCharacters))
        .filter(pathElement => pathElement)
        .join(separator)
        .concat(separator);
    const maxhumanLength = maxLength - HASH_LEN;
    return human.length > maxhumanLength ? `${splitInMiddle(human, maxhumanLength)}${hash}` : `${human}${hash}`;
}
exports.makeUniqueResourceName = makeUniqueResourceName;
/**
 * Take a hash of the given path.
 *
 * The hash is limited in size.
 */
function pathHash(path) {
    const md5 = (0, md5_1.md5hash)(path.join(PATH_SEP));
    return md5.slice(0, HASH_LEN).toUpperCase();
}
/**
 * Removes all non-allowed special characters in a string.
 */
function removeNonAllowedSpecialCharacters(s, _separator, allowedSpecialCharacters) {
    const pattern = allowedSpecialCharacters ? `[^A-Za-z0-9${allowedSpecialCharacters}]` : '[^A-Za-z0-9]';
    const regex = new RegExp(pattern, 'g');
    return s.replace(regex, '');
}
/**
 * Remove duplicate "terms" from the path list
 *
 * If the previous path component name ends with this component name, skip the
 * current component.
 */
function removeDupes(path) {
    const ret = new Array();
    for (const component of path) {
        if (ret.length === 0 || !ret[ret.length - 1].endsWith(component)) {
            ret.push(component);
        }
    }
    return ret;
}
function splitInMiddle(s, maxLength = MAX_LEN - HASH_LEN) {
    const half = maxLength / 2;
    return s.slice(0, half) + s.slice(-half);
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidW5pcXVlLXJlc291cmNlLW5hbWUuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJ1bmlxdWUtcmVzb3VyY2UtbmFtZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7QUFBQSwrQkFBZ0M7QUFvQ2hDOzs7OztHQUtHO0FBQ0gsTUFBTSxvQkFBb0IsR0FBRyxVQUFVLENBQUM7QUFFeEM7O0VBRUU7QUFDRixNQUFNLFNBQVMsR0FBRyxTQUFTLENBQUM7QUFFNUIsTUFBTSxRQUFRLEdBQUcsR0FBRyxDQUFDO0FBRXJCLE1BQU0sT0FBTyxHQUFHLEdBQUcsQ0FBQztBQUVwQixNQUFNLFFBQVEsR0FBRyxDQUFDLENBQUM7QUFFbkIsU0FBZ0Isc0JBQXNCLENBQUMsVUFBb0IsRUFBRSxPQUFzQztJQUNqRyxNQUFNLFNBQVMsR0FBRyxPQUFPLENBQUMsU0FBUyxJQUFJLEdBQUcsQ0FBQztJQUMzQyxNQUFNLFNBQVMsR0FBRyxPQUFPLENBQUMsU0FBUyxJQUFJLEVBQUUsQ0FBQztJQUMxQyxNQUFNLE1BQU0sR0FBRyxPQUFPLENBQUMsTUFBTSxJQUFJLEVBQUUsQ0FBQztJQUNwQyxVQUFVLEdBQUcsVUFBVSxDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDLENBQUMsS0FBSyxTQUFTLENBQUMsQ0FBQztJQUVyRCxJQUFJLFVBQVUsQ0FBQyxNQUFNLEtBQUssQ0FBQyxFQUFFO1FBQzNCLE1BQU0sSUFBSSxLQUFLLENBQUMsMkVBQTJFLENBQUMsQ0FBQztLQUM5RjtJQUVELHdGQUF3RjtJQUN4RixvRkFBb0Y7SUFDcEYsZ0NBQWdDO0lBQ2hDLElBQUksVUFBVSxDQUFDLE1BQU0sS0FBSyxDQUFDLEVBQUU7UUFDM0IsTUFBTSxnQkFBZ0IsR0FBRyxNQUFNLEdBQUcsaUNBQWlDLENBQUMsVUFBVSxDQUFDLENBQUMsQ0FBQyxFQUFFLFNBQVMsRUFBRSxPQUFPLENBQUMsd0JBQXdCLENBQUMsQ0FBQztRQUVoSSxJQUFJLGdCQUFnQixDQUFDLE1BQU0sSUFBSSxTQUFTLEVBQUU7WUFDeEMsT0FBTyxnQkFBZ0IsQ0FBQztTQUN6QjtLQUNGO0lBRUQsdUdBQXVHO0lBQ3ZHLE1BQU0sSUFBSSxHQUFHLFFBQVEsQ0FBQyxVQUFVLENBQUMsQ0FBQztJQUNsQyxNQUFNLEtBQUssR0FBRyxNQUFNLEdBQUcsV0FBVyxDQUFDLFVBQVUsQ0FBQztTQUMzQyxNQUFNLENBQUMsV0FBVyxDQUFDLEVBQUUsQ0FBQyxXQUFXLEtBQUssb0JBQW9CLENBQUM7U0FDM0QsR0FBRyxDQUFDLFdBQVcsQ0FBQyxFQUFFLENBQUMsaUNBQWlDLENBQUMsV0FBVyxFQUFFLFNBQVMsRUFBRSxPQUFPLENBQUMsd0JBQXdCLENBQUMsQ0FBQztTQUMvRyxNQUFNLENBQUMsV0FBVyxDQUFDLEVBQUUsQ0FBQyxXQUFXLENBQUM7U0FDbEMsSUFBSSxDQUFDLFNBQVMsQ0FBQztTQUNmLE1BQU0sQ0FBQyxTQUFTLENBQUMsQ0FBQztJQUVyQixNQUFNLGNBQWMsR0FBRyxTQUFTLEdBQUcsUUFBUSxDQUFDO0lBQzVDLE9BQU8sS0FBSyxDQUFDLE1BQU0sR0FBRyxjQUFjLENBQUMsQ0FBQyxDQUFDLEdBQUcsYUFBYSxDQUFDLEtBQUssRUFBRSxjQUFjLENBQUMsR0FBRyxJQUFJLEVBQUUsQ0FBQSxDQUFDLENBQUMsR0FBRyxLQUFLLEdBQUcsSUFBSSxFQUFFLENBQUM7QUFDN0csQ0FBQztBQWhDRCx3REFnQ0M7QUFFRDs7OztHQUlHO0FBQ0gsU0FBUyxRQUFRLENBQUMsSUFBYztJQUM5QixNQUFNLEdBQUcsR0FBRyxJQUFBLGFBQU8sRUFBQyxJQUFJLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxDQUFDLENBQUM7SUFDekMsT0FBTyxHQUFHLENBQUMsS0FBSyxDQUFDLENBQUMsRUFBRSxRQUFRLENBQUMsQ0FBQyxXQUFXLEVBQUUsQ0FBQztBQUM5QyxDQUFDO0FBRUQ7O0dBRUc7QUFDSCxTQUFTLGlDQUFpQyxDQUFDLENBQVMsRUFBRSxVQUFrQixFQUFFLHdCQUFpQztJQUN6RyxNQUFNLE9BQU8sR0FBRyx3QkFBd0IsQ0FBQyxDQUFDLENBQUMsY0FBYyx3QkFBd0IsR0FBRyxDQUFDLENBQUMsQ0FBQyxjQUFjLENBQUM7SUFDdEcsTUFBTSxLQUFLLEdBQUcsSUFBSSxNQUFNLENBQUMsT0FBTyxFQUFFLEdBQUcsQ0FBQyxDQUFDO0lBQ3ZDLE9BQU8sQ0FBQyxDQUFDLE9BQU8sQ0FBQyxLQUFLLEVBQUUsRUFBRSxDQUFDLENBQUM7QUFDOUIsQ0FBQztBQUVEOzs7OztHQUtHO0FBQ0gsU0FBUyxXQUFXLENBQUMsSUFBYztJQUNqQyxNQUFNLEdBQUcsR0FBRyxJQUFJLEtBQUssRUFBVSxDQUFDO0lBRWhDLEtBQUssTUFBTSxTQUFTLElBQUksSUFBSSxFQUFFO1FBQzVCLElBQUksR0FBRyxDQUFDLE1BQU0sS0FBSyxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsR0FBRyxDQUFDLE1BQU0sR0FBRyxDQUFDLENBQUMsQ0FBQyxRQUFRLENBQUMsU0FBUyxDQUFDLEVBQUU7WUFDaEUsR0FBRyxDQUFDLElBQUksQ0FBQyxTQUFTLENBQUMsQ0FBQztTQUNyQjtLQUNGO0lBQ0QsT0FBTyxHQUFHLENBQUM7QUFDYixDQUFDO0FBRUQsU0FBUyxhQUFhLENBQUMsQ0FBUyxFQUFFLFlBQW9CLE9BQU8sR0FBRyxRQUFRO0lBQ3RFLE1BQU0sSUFBSSxHQUFHLFNBQVMsR0FBRyxDQUFDLENBQUM7SUFDM0IsT0FBTyxDQUFDLENBQUMsS0FBSyxDQUFDLENBQUMsRUFBRSxJQUFJLENBQUMsR0FBRyxDQUFDLENBQUMsS0FBSyxDQUFDLENBQUMsSUFBSSxDQUFDLENBQUM7QUFDM0MsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IG1kNWhhc2ggfSBmcm9tICcuL21kNSc7XG5cbi8qKlxuICogT3B0aW9ucyBmb3IgY3JlYXRpbmcgYSB1bmlxdWUgcmVzb3VyY2UgbmFtZS5cbiovXG5pbnRlcmZhY2UgTWFrZVVuaXF1ZVJlc291cmNlTmFtZU9wdGlvbnMge1xuXG4gIC8qKlxuICAgKiBUaGUgbWF4aW11bSBsZW5ndGggb2YgdGhlIHVuaXF1ZSByZXNvdXJjZSBuYW1lLlxuICAgKlxuICAgKiBAZGVmYXVsdCAtIDI1NlxuICAgKi9cbiAgcmVhZG9ubHkgbWF4TGVuZ3RoPzogbnVtYmVyO1xuXG4gIC8qKlxuICAgKiBUaGUgc2VwYXJhdG9yIHVzZWQgYmV0d2VlbiB0aGUgcGF0aCBjb21wb25lbnRzLlxuICAgKlxuICAgKiBAZGVmYXVsdCAtIG5vbmVcbiAgICovXG4gIHJlYWRvbmx5IHNlcGFyYXRvcj86IHN0cmluZztcblxuICAvKipcbiAgICogTm9uLWFscGhhbnVtZXJpYyBjaGFyYWN0ZXJzIGFsbG93ZWQgaW4gdGhlIHVuaXF1ZSByZXNvdXJjZSBuYW1lLlxuICAgKlxuICAgKiBAZGVmYXVsdCAtIG5vbmVcbiAgICovXG4gIHJlYWRvbmx5IGFsbG93ZWRTcGVjaWFsQ2hhcmFjdGVycz86IHN0cmluZztcblxuICAvKipcbiAgICogUHJlZml4IHRvIGJlIGFkZGVkIGludG8gdGhlIHN0YWNrIG5hbWVcbiAgICpcbiAgICogQGRlZmF1bHQgLSBub25lXG4gICAqL1xuICByZWFkb25seSBwcmVmaXg/OiBzdHJpbmc7XG59XG5cbi8qKlxuICogUmVzb3VyY2VzIHdpdGggdGhpcyBJRCBhcmUgaGlkZGVuIGZyb20gaHVtYW5zXG4gKlxuICogVGhleSBkbyBub3QgYXBwZWFyIGluIHRoZSBodW1hbi1yZWFkYWJsZSBwYXJ0IG9mIHRoZSBsb2dpY2FsIElELFxuICogYnV0IHRoZXkgYXJlIGluY2x1ZGVkIGluIHRoZSBoYXNoIGNhbGN1bGF0aW9uLlxuICovXG5jb25zdCBISURERU5fRlJPTV9IVU1BTl9JRCA9ICdSZXNvdXJjZSc7XG5cbi8qKlxuKiBSZXNvdXJjZXMgd2l0aCB0aGlzIElEIGFyZSBjb21wbGV0ZSBoaWRkZW4gZnJvbSB0aGUgbG9naWNhbCBJRCBjYWxjdWxhdGlvbi5cbiovXG5jb25zdCBISURERU5fSUQgPSAnRGVmYXVsdCc7XG5cbmNvbnN0IFBBVEhfU0VQID0gJy8nO1xuXG5jb25zdCBNQVhfTEVOID0gMjU2O1xuXG5jb25zdCBIQVNIX0xFTiA9IDg7XG5cbmV4cG9ydCBmdW5jdGlvbiBtYWtlVW5pcXVlUmVzb3VyY2VOYW1lKGNvbXBvbmVudHM6IHN0cmluZ1tdLCBvcHRpb25zOiBNYWtlVW5pcXVlUmVzb3VyY2VOYW1lT3B0aW9ucykge1xuICBjb25zdCBtYXhMZW5ndGggPSBvcHRpb25zLm1heExlbmd0aCA/PyAyNTY7XG4gIGNvbnN0IHNlcGFyYXRvciA9IG9wdGlvbnMuc2VwYXJhdG9yID8/ICcnO1xuICBjb25zdCBwcmVmaXggPSBvcHRpb25zLnByZWZpeCA/PyAnJztcbiAgY29tcG9uZW50cyA9IGNvbXBvbmVudHMuZmlsdGVyKHggPT4geCAhPT0gSElEREVOX0lEKTtcblxuICBpZiAoY29tcG9uZW50cy5sZW5ndGggPT09IDApIHtcbiAgICB0aHJvdyBuZXcgRXJyb3IoJ1VuYWJsZSB0byBjYWxjdWxhdGUgYSB1bmlxdWUgcmVzb3VyY2UgbmFtZSBmb3IgYW4gZW1wdHkgc2V0IG9mIGNvbXBvbmVudHMnKTtcbiAgfVxuXG4gIC8vIHRvcC1sZXZlbCByZXNvdXJjZXMgd2lsbCBzaW1wbHkgdXNlIHRoZSBgbmFtZWAgYXMtaXMgaWYgdGhlIG5hbWUgaXMgYWxzbyBzaG9ydCBlbm91Z2hcbiAgLy8gaW4gb3JkZXIgdG8gc3VwcG9ydCB0cmFuc3BhcmVudCBtaWdyYXRpb24gb2YgUk9TIHRlbXBsYXRlcyB0byB0aGUgQ0RLIHdpdGhvdXQgdGhlXG4gIC8vIG5lZWQgdG8gcmVuYW1lIGFsbCByZXNvdXJjZXMuXG4gIGlmIChjb21wb25lbnRzLmxlbmd0aCA9PT0gMSkge1xuICAgIGNvbnN0IHRvcExldmVsUmVzb3VyY2UgPSBwcmVmaXggKyByZW1vdmVOb25BbGxvd2VkU3BlY2lhbENoYXJhY3RlcnMoY29tcG9uZW50c1swXSwgc2VwYXJhdG9yLCBvcHRpb25zLmFsbG93ZWRTcGVjaWFsQ2hhcmFjdGVycyk7XG5cbiAgICBpZiAodG9wTGV2ZWxSZXNvdXJjZS5sZW5ndGggPD0gbWF4TGVuZ3RoKSB7XG4gICAgICByZXR1cm4gdG9wTGV2ZWxSZXNvdXJjZTtcbiAgICB9XG4gIH1cblxuICAvLyBDYWxjdWxhdGUgdGhlIGhhc2ggZnJvbSB0aGUgZnVsbCBwYXRoLCBpbmNsdWRlZCB1bnJlc29sdmVkIHRva2VucyBzbyB0aGUgaGFzaCB2YWx1ZSBpcyBhbHdheXMgdW5pcXVlXG4gIGNvbnN0IGhhc2ggPSBwYXRoSGFzaChjb21wb25lbnRzKTtcbiAgY29uc3QgaHVtYW4gPSBwcmVmaXggKyByZW1vdmVEdXBlcyhjb21wb25lbnRzKVxuICAgIC5maWx0ZXIocGF0aEVsZW1lbnQgPT4gcGF0aEVsZW1lbnQgIT09IEhJRERFTl9GUk9NX0hVTUFOX0lEKVxuICAgIC5tYXAocGF0aEVsZW1lbnQgPT4gcmVtb3ZlTm9uQWxsb3dlZFNwZWNpYWxDaGFyYWN0ZXJzKHBhdGhFbGVtZW50LCBzZXBhcmF0b3IsIG9wdGlvbnMuYWxsb3dlZFNwZWNpYWxDaGFyYWN0ZXJzKSlcbiAgICAuZmlsdGVyKHBhdGhFbGVtZW50ID0+IHBhdGhFbGVtZW50KVxuICAgIC5qb2luKHNlcGFyYXRvcilcbiAgICAuY29uY2F0KHNlcGFyYXRvcik7XG5cbiAgY29uc3QgbWF4aHVtYW5MZW5ndGggPSBtYXhMZW5ndGggLSBIQVNIX0xFTjtcbiAgcmV0dXJuIGh1bWFuLmxlbmd0aCA+IG1heGh1bWFuTGVuZ3RoID8gYCR7c3BsaXRJbk1pZGRsZShodW1hbiwgbWF4aHVtYW5MZW5ndGgpfSR7aGFzaH1gOiBgJHtodW1hbn0ke2hhc2h9YDtcbn1cblxuLyoqXG4gKiBUYWtlIGEgaGFzaCBvZiB0aGUgZ2l2ZW4gcGF0aC5cbiAqXG4gKiBUaGUgaGFzaCBpcyBsaW1pdGVkIGluIHNpemUuXG4gKi9cbmZ1bmN0aW9uIHBhdGhIYXNoKHBhdGg6IHN0cmluZ1tdKTogc3RyaW5nIHtcbiAgY29uc3QgbWQ1ID0gbWQ1aGFzaChwYXRoLmpvaW4oUEFUSF9TRVApKTtcbiAgcmV0dXJuIG1kNS5zbGljZSgwLCBIQVNIX0xFTikudG9VcHBlckNhc2UoKTtcbn1cblxuLyoqXG4gKiBSZW1vdmVzIGFsbCBub24tYWxsb3dlZCBzcGVjaWFsIGNoYXJhY3RlcnMgaW4gYSBzdHJpbmcuXG4gKi9cbmZ1bmN0aW9uIHJlbW92ZU5vbkFsbG93ZWRTcGVjaWFsQ2hhcmFjdGVycyhzOiBzdHJpbmcsIF9zZXBhcmF0b3I6IHN0cmluZywgYWxsb3dlZFNwZWNpYWxDaGFyYWN0ZXJzPzogc3RyaW5nKSB7XG4gIGNvbnN0IHBhdHRlcm4gPSBhbGxvd2VkU3BlY2lhbENoYXJhY3RlcnMgPyBgW15BLVphLXowLTkke2FsbG93ZWRTcGVjaWFsQ2hhcmFjdGVyc31dYCA6ICdbXkEtWmEtejAtOV0nO1xuICBjb25zdCByZWdleCA9IG5ldyBSZWdFeHAocGF0dGVybiwgJ2cnKTtcbiAgcmV0dXJuIHMucmVwbGFjZShyZWdleCwgJycpO1xufVxuXG4vKipcbiAqIFJlbW92ZSBkdXBsaWNhdGUgXCJ0ZXJtc1wiIGZyb20gdGhlIHBhdGggbGlzdFxuICpcbiAqIElmIHRoZSBwcmV2aW91cyBwYXRoIGNvbXBvbmVudCBuYW1lIGVuZHMgd2l0aCB0aGlzIGNvbXBvbmVudCBuYW1lLCBza2lwIHRoZVxuICogY3VycmVudCBjb21wb25lbnQuXG4gKi9cbmZ1bmN0aW9uIHJlbW92ZUR1cGVzKHBhdGg6IHN0cmluZ1tdKTogc3RyaW5nW10ge1xuICBjb25zdCByZXQgPSBuZXcgQXJyYXk8c3RyaW5nPigpO1xuXG4gIGZvciAoY29uc3QgY29tcG9uZW50IG9mIHBhdGgpIHtcbiAgICBpZiAocmV0Lmxlbmd0aCA9PT0gMCB8fCAhcmV0W3JldC5sZW5ndGggLSAxXS5lbmRzV2l0aChjb21wb25lbnQpKSB7XG4gICAgICByZXQucHVzaChjb21wb25lbnQpO1xuICAgIH1cbiAgfVxuICByZXR1cm4gcmV0O1xufVxuXG5mdW5jdGlvbiBzcGxpdEluTWlkZGxlKHM6IHN0cmluZywgbWF4TGVuZ3RoOiBudW1iZXIgPSBNQVhfTEVOIC0gSEFTSF9MRU4pIHtcbiAgY29uc3QgaGFsZiA9IG1heExlbmd0aCAvIDI7XG4gIHJldHVybiBzLnNsaWNlKDAsIGhhbGYpICsgcy5zbGljZSgtaGFsZik7XG59Il19