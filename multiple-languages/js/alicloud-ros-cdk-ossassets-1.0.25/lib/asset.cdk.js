"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.Asset = void 0;
const path = require("path");
const ros = require("@alicloud/ros-cdk-core");
const cxapi = require("@alicloud/ros-cdk-cxapi");
/**
 * An asset represents a local file or directory, which is automatically uploaded to OSS bucket
 * and then can be referenced within a CDK application.
 */
class Asset extends ros.Resource {
    constructor(scope, id, props) {
        super(scope, id);
        this.isBundled = props.bundling != null;
        // stage the asset source (conditionally).
        const staging = new ros.AssetStaging(this, 'Stage', {
            ...props,
            sourcePath: path.resolve(props.path),
            follow: props.followSymlinks,
            assetHash: props.assetHash,
        });
        this.assetHash = staging.assetHash;
        const stack = ros.Stack.of(this);
        this.assetPath = staging.relativeStagedPath(stack);
        this.isFile = staging.packaging === ros.FileAssetPackaging.FILE;
        this.isZipArchive = staging.isArchive;
        const location = stack.synthesizer.addFileAsset({
            packaging: staging.packaging,
            sourceHash: this.assetHash,
            fileName: this.assetPath,
            deployTime: props.deployTime,
        });
        this.bucketName = location.bucketName;
        this.objectKey = location.objectKey;
        this.httpUrl = location.httpUrl;
    }
    /**
     * Adds ROS template metadata to the specified resource with
     * information that indicates which resource property is mapped to this local
     * asset.
     *
     * Asset metadata will only be included if the stack is synthesized with the
     * "ros:cdk:enable-asset-metadata" context key defined, which is the default
     * behavior when synthesizing via the CDK Toolkit.
     *
     * @param resource The ROS resource which is using this asset
     * @param resourceProperty The property name where this asset is referenced
     */
    addResourceMetadata(resource, resourceProperty) {
        if (!this.node.tryGetContext(cxapi.ASSET_RESOURCE_METADATA_ENABLED_CONTEXT)) {
            return; // not enabled
        }
        resource.rosOptions.metadata = resource.rosOptions.metadata || {};
        resource.rosOptions.metadata[cxapi.ASSET_RESOURCE_METADATA_PATH_KEY] = this.assetPath;
        resource.rosOptions.metadata[cxapi.ASSET_RESOURCE_METADATA_IS_BUNDLED_KEY] = this.isBundled;
        resource.rosOptions.metadata[cxapi.ASSET_RESOURCE_METADATA_PROPERTY_KEY] = resourceProperty;
    }
}
exports.Asset = Asset;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYXNzZXQuY2RrLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiYXNzZXQuY2RrLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7OztBQUFBLDZCQUE2QjtBQUM3Qiw4Q0FBOEM7QUFDOUMsaURBQWlEO0FBK0JqRDs7O0dBR0c7QUFDSCxNQUFhLEtBQU0sU0FBUSxHQUFHLENBQUMsUUFBUTtJQW9EbkMsWUFBWSxLQUFvQixFQUFFLEVBQVUsRUFBRSxLQUFpQjtRQUMzRCxLQUFLLENBQUMsS0FBSyxFQUFFLEVBQUUsQ0FBQyxDQUFDO1FBRWpCLElBQUksQ0FBQyxTQUFTLEdBQUcsS0FBSyxDQUFDLFFBQVEsSUFBSSxJQUFJLENBQUM7UUFFeEMsMENBQTBDO1FBQzFDLE1BQU0sT0FBTyxHQUFHLElBQUksR0FBRyxDQUFDLFlBQVksQ0FBQyxJQUFJLEVBQUUsT0FBTyxFQUFFO1lBQ2hELEdBQUcsS0FBSztZQUNSLFVBQVUsRUFBRSxJQUFJLENBQUMsT0FBTyxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUM7WUFDcEMsTUFBTSxFQUFFLEtBQUssQ0FBQyxjQUFjO1lBQzVCLFNBQVMsRUFBRSxLQUFLLENBQUMsU0FBUztTQUM3QixDQUFDLENBQUM7UUFFSCxJQUFJLENBQUMsU0FBUyxHQUFHLE9BQU8sQ0FBQyxTQUFTLENBQUM7UUFFbkMsTUFBTSxLQUFLLEdBQUcsR0FBRyxDQUFDLEtBQUssQ0FBQyxFQUFFLENBQUMsSUFBSSxDQUFDLENBQUM7UUFFakMsSUFBSSxDQUFDLFNBQVMsR0FBRyxPQUFPLENBQUMsa0JBQWtCLENBQUMsS0FBSyxDQUFDLENBQUM7UUFFbkQsSUFBSSxDQUFDLE1BQU0sR0FBRyxPQUFPLENBQUMsU0FBUyxLQUFLLEdBQUcsQ0FBQyxrQkFBa0IsQ0FBQyxJQUFJLENBQUM7UUFFaEUsSUFBSSxDQUFDLFlBQVksR0FBRyxPQUFPLENBQUMsU0FBUyxDQUFDO1FBRXRDLE1BQU0sUUFBUSxHQUFHLEtBQUssQ0FBQyxXQUFXLENBQUMsWUFBWSxDQUFDO1lBQzVDLFNBQVMsRUFBRSxPQUFPLENBQUMsU0FBUztZQUM1QixVQUFVLEVBQUUsSUFBSSxDQUFDLFNBQVM7WUFDMUIsUUFBUSxFQUFFLElBQUksQ0FBQyxTQUFTO1lBQ3hCLFVBQVUsRUFBRSxLQUFLLENBQUMsVUFBVTtTQUMvQixDQUFDLENBQUM7UUFFSCxJQUFJLENBQUMsVUFBVSxHQUFHLFFBQVEsQ0FBQyxVQUFVLENBQUM7UUFDdEMsSUFBSSxDQUFDLFNBQVMsR0FBRyxRQUFRLENBQUMsU0FBUyxDQUFDO1FBQ3BDLElBQUksQ0FBQyxPQUFPLEdBQUcsUUFBUSxDQUFDLE9BQU8sQ0FBQztJQUNwQyxDQUFDO0lBR0Q7Ozs7Ozs7Ozs7O09BV0c7SUFDSSxtQkFBbUIsQ0FBQyxRQUF5QixFQUFFLGdCQUF3QjtRQUMxRSxJQUFJLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxhQUFhLENBQUMsS0FBSyxDQUFDLHVDQUF1QyxDQUFDLEVBQUU7WUFDekUsT0FBTyxDQUFDLGNBQWM7U0FDekI7UUFDRCxRQUFRLENBQUMsVUFBVSxDQUFDLFFBQVEsR0FBRyxRQUFRLENBQUMsVUFBVSxDQUFDLFFBQVEsSUFBSSxFQUFHLENBQUM7UUFDbkUsUUFBUSxDQUFDLFVBQVUsQ0FBQyxRQUFRLENBQUMsS0FBSyxDQUFDLGdDQUFnQyxDQUFDLEdBQUcsSUFBSSxDQUFDLFNBQVMsQ0FBQztRQUN0RixRQUFRLENBQUMsVUFBVSxDQUFDLFFBQVEsQ0FBQyxLQUFLLENBQUMsc0NBQXNDLENBQUMsR0FBRyxJQUFJLENBQUMsU0FBUyxDQUFDO1FBQzVGLFFBQVEsQ0FBQyxVQUFVLENBQUMsUUFBUSxDQUFDLEtBQUssQ0FBQyxvQ0FBb0MsQ0FBQyxHQUFHLGdCQUFnQixDQUFDO0lBQ2hHLENBQUM7Q0FDSjtBQTdHRCxzQkE2R0MiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgKiBhcyBwYXRoIGZyb20gJ3BhdGgnO1xuaW1wb3J0ICogYXMgcm9zIGZyb20gJ0BhbGljbG91ZC9yb3MtY2RrLWNvcmUnO1xuaW1wb3J0ICogYXMgY3hhcGkgZnJvbSAnQGFsaWNsb3VkL3Jvcy1jZGstY3hhcGknO1xuXG5leHBvcnQgaW50ZXJmYWNlIEFzc2V0T3B0aW9ucyBleHRlbmRzIHJvcy5GaWxlQ29weU9wdGlvbnMsIHJvcy5Bc3NldE9wdGlvbnMge1xuXG4gICAgLyoqXG4gICAgICogV2hldGhlciBvciBub3QgdGhlIGFzc2V0IG5lZWRzIHRvIGV4aXN0IGJleW9uZCBkZXBsb3ltZW50IHRpbWU7IGkuZS5cbiAgICAgKiBhcmUgY29waWVkIG92ZXIgdG8gYSBkaWZmZXJlbnQgbG9jYXRpb24gYW5kIG5vdCBuZWVkZWQgYWZ0ZXJ3YXJkcy5cbiAgICAgKiBTZXR0aW5nIHRoaXMgcHJvcGVydHkgdG8gdHJ1ZSBoYXMgYW4gaW1wYWN0IG9uIHRoZSBsaWZlY3ljbGUgb2YgdGhlIGFzc2V0LFxuICAgICAqIGJlY2F1c2Ugd2Ugd2lsbCBhc3N1bWUgdGhhdCBpdCBpcyBzYWZlIHRvIGRlbGV0ZSBhZnRlciB0aGUgUk9TXG4gICAgICogZGVwbG95bWVudCBzdWNjZWVkcy5cbiAgICAgKlxuICAgICAqIEZvciBleGFtcGxlLCBGQyBGdW5jdGlvbiBhc3NldHMgYXJlIGNvcGllZCBvdmVyIHRvIEZ1bmN0aW9uIGR1cmluZ1xuICAgICAqIGRlcGxveW1lbnQuIFRoZXJlZm9yZSwgaXQgaXMgbm90IG5lY2Vzc2FyeSB0byBzdG9yZSB0aGUgYXNzZXQgaW4gT1NTIGJ1Y2tldCxcbiAgICAgKiBzbyB3ZSBjb25zaWRlciB0aG9zZSBkZXBsb3lUaW1lIGFzc2V0cy5cbiAgICAgKlxuICAgICAqIEBkZWZhdWx0IGZhbHNlXG4gICAgICovXG4gICAgcmVhZG9ubHkgZGVwbG95VGltZT86IGJvb2xlYW47XG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgQXNzZXRQcm9wcyBleHRlbmRzIEFzc2V0T3B0aW9ucyB7XG4gICAgLyoqXG4gICAgICogVGhlIGRpc2sgbG9jYXRpb24gb2YgdGhlIGFzc2V0LlxuICAgICAqXG4gICAgICogVGhlIHBhdGggc2hvdWxkIHJlZmVyIHRvIG9uZSBvZiB0aGUgZm9sbG93aW5nOlxuICAgICAqIC0gQSByZWd1bGFyIGZpbGUgb3IgYSAuemlwIGZpbGUsIGluIHdoaWNoIGNhc2UgdGhlIGZpbGUgd2lsbCBiZSB1cGxvYWRlZCBhcy1pcyB0byBPU1MgYnVja2V0LlxuICAgICAqIC0gQSBkaXJlY3RvcnksIGluIHdoaWNoIGNhc2UgaXQgd2lsbCBiZSBhcmNoaXZlZCBpbnRvIGEgLnppcCBmaWxlIGFuZCB1cGxvYWRlZCB0byBPU1MgYnVja2V0LlxuICAgICAqL1xuICAgIHJlYWRvbmx5IHBhdGg6IHN0cmluZztcbn1cblxuLyoqXG4gKiBBbiBhc3NldCByZXByZXNlbnRzIGEgbG9jYWwgZmlsZSBvciBkaXJlY3RvcnksIHdoaWNoIGlzIGF1dG9tYXRpY2FsbHkgdXBsb2FkZWQgdG8gT1NTIGJ1Y2tldFxuICogYW5kIHRoZW4gY2FuIGJlIHJlZmVyZW5jZWQgd2l0aGluIGEgQ0RLIGFwcGxpY2F0aW9uLlxuICovXG5leHBvcnQgY2xhc3MgQXNzZXQgZXh0ZW5kcyByb3MuUmVzb3VyY2Uge1xuICAgIC8qKlxuICAgICAqIEF0dHJpYnV0ZSB0aGF0IHJlcHJlc2VudHMgdGhlIG5hbWUgb2YgdGhlIE9TUyBidWNrZXQgdGhpcyBhc3NldCBleGlzdHMgaW4uXG4gICAgICovXG4gICAgcHVibGljIHJlYWRvbmx5IGJ1Y2tldE5hbWU6IHN0cmluZztcblxuICAgIC8qKlxuICAgICAqIEF0dHJpYnV0ZSB3aGljaCByZXByZXNlbnRzIHRoZSBPU1Mgb2JqZWN0IGtleSBvZiB0aGlzIGFzc2V0LlxuICAgICAqL1xuICAgIHB1YmxpYyByZWFkb25seSBvYmplY3RLZXk6IHN0cmluZztcblxuICAgIC8qKlxuICAgICAqIEF0dHJpYnV0ZSB3aGljaCByZXByZXNlbnRzIHRoZSBPU1MgSFRUUCBVUkwgb2YgdGhpcyBhc3NldC5cbiAgICAgKiBGb3IgZXhhbXBsZSwgYGh0dHBzOi8vJHtidWNrZXROYW1lfS5vc3MtJHtyZWdpb259LmFsaXl1bmNzLmNvbS8ke29iamVjdEtleX1gXG4gICAgICovXG4gICAgcHVibGljIHJlYWRvbmx5IGh0dHBVcmw6IHN0cmluZztcblxuICAgIC8qKlxuICAgICAqIFRoZSBwYXRoIHRvIHRoZSBhc3NldCwgcmVsYXRpdmUgdG8gdGhlIGN1cnJlbnQgQ2xvdWQgQXNzZW1ibHlcbiAgICAgKlxuICAgICAqIElmIGFzc2V0IHN0YWdpbmcgaXMgZGlzYWJsZWQsIHRoaXMgd2lsbCBqdXN0IGJlIHRoZSBvcmlnaW5hbCBwYXRoLlxuICAgICAqIElmIGFzc2V0IHN0YWdpbmcgaXMgZW5hYmxlZCBpdCB3aWxsIGJlIHRoZSBzdGFnZWQgcGF0aC5cbiAgICAgKi9cbiAgICBwdWJsaWMgcmVhZG9ubHkgYXNzZXRQYXRoOiBzdHJpbmc7XG5cbiAgICAvKipcbiAgICAgKiBUaGUgT1NTIGJ1Y2tldCBpbiB3aGljaCB0aGlzIGFzc2V0IHJlc2lkZXMuXG4gICAgICovXG4gICAgLy8gcHVibGljIHJlYWRvbmx5IGJ1Y2tldDogQnVja2V0O1xuXG4gICAgLyoqXG4gICAgICogSW5kaWNhdGVzIGlmIHRoaXMgYXNzZXQgaXMgYSBzaW5nbGUgZmlsZS4gQWxsb3dzIGNvbnN0cnVjdHMgdG8gZW5zdXJlIHRoYXQgdGhlXG4gICAgICogY29ycmVjdCBmaWxlIHR5cGUgd2FzIHVzZWQuXG4gICAgICovXG4gICAgcHVibGljIHJlYWRvbmx5IGlzRmlsZTogYm9vbGVhbjtcblxuICAgIC8qKlxuICAgICAqIEluZGljYXRlcyBpZiB0aGlzIGFzc2V0IGlzIGEgemlwIGFyY2hpdmUuIEFsbG93cyBjb25zdHJ1Y3RzIHRvIGVuc3VyZSB0aGF0IHRoZVxuICAgICAqIGNvcnJlY3QgZmlsZSB0eXBlIHdhcyB1c2VkLlxuICAgICAqL1xuICAgIHB1YmxpYyByZWFkb25seSBpc1ppcEFyY2hpdmU6IGJvb2xlYW47XG5cbiAgICAvKipcbiAgICAgKiBBIGNyeXB0b2dyYXBoaWMgaGFzaCBvZiB0aGUgYXNzZXQuXG4gICAgICovXG4gICAgcHVibGljIHJlYWRvbmx5IGFzc2V0SGFzaDogc3RyaW5nO1xuXG4gICAgLyoqXG4gICAgICogSW5kaWNhdGVzIGlmIHRoaXMgYXNzZXQgZ290IGJ1bmRsZWQgYmVmb3JlIHN0YWdlZCwgb3Igbm90LlxuICAgICAqL1xuICAgIHByaXZhdGUgcmVhZG9ubHkgaXNCdW5kbGVkOiBib29sZWFuO1xuXG4gICAgY29uc3RydWN0b3Ioc2NvcGU6IHJvcy5Db25zdHJ1Y3QsIGlkOiBzdHJpbmcsIHByb3BzOiBBc3NldFByb3BzKSB7XG4gICAgICAgIHN1cGVyKHNjb3BlLCBpZCk7XG5cbiAgICAgICAgdGhpcy5pc0J1bmRsZWQgPSBwcm9wcy5idW5kbGluZyAhPSBudWxsO1xuXG4gICAgICAgIC8vIHN0YWdlIHRoZSBhc3NldCBzb3VyY2UgKGNvbmRpdGlvbmFsbHkpLlxuICAgICAgICBjb25zdCBzdGFnaW5nID0gbmV3IHJvcy5Bc3NldFN0YWdpbmcodGhpcywgJ1N0YWdlJywge1xuICAgICAgICAgICAgLi4ucHJvcHMsXG4gICAgICAgICAgICBzb3VyY2VQYXRoOiBwYXRoLnJlc29sdmUocHJvcHMucGF0aCksXG4gICAgICAgICAgICBmb2xsb3c6IHByb3BzLmZvbGxvd1N5bWxpbmtzLFxuICAgICAgICAgICAgYXNzZXRIYXNoOiBwcm9wcy5hc3NldEhhc2gsXG4gICAgICAgIH0pO1xuXG4gICAgICAgIHRoaXMuYXNzZXRIYXNoID0gc3RhZ2luZy5hc3NldEhhc2g7XG5cbiAgICAgICAgY29uc3Qgc3RhY2sgPSByb3MuU3RhY2sub2YodGhpcyk7XG5cbiAgICAgICAgdGhpcy5hc3NldFBhdGggPSBzdGFnaW5nLnJlbGF0aXZlU3RhZ2VkUGF0aChzdGFjayk7XG5cbiAgICAgICAgdGhpcy5pc0ZpbGUgPSBzdGFnaW5nLnBhY2thZ2luZyA9PT0gcm9zLkZpbGVBc3NldFBhY2thZ2luZy5GSUxFO1xuXG4gICAgICAgIHRoaXMuaXNaaXBBcmNoaXZlID0gc3RhZ2luZy5pc0FyY2hpdmU7XG5cbiAgICAgICAgY29uc3QgbG9jYXRpb24gPSBzdGFjay5zeW50aGVzaXplci5hZGRGaWxlQXNzZXQoe1xuICAgICAgICAgICAgcGFja2FnaW5nOiBzdGFnaW5nLnBhY2thZ2luZyxcbiAgICAgICAgICAgIHNvdXJjZUhhc2g6IHRoaXMuYXNzZXRIYXNoLFxuICAgICAgICAgICAgZmlsZU5hbWU6IHRoaXMuYXNzZXRQYXRoLFxuICAgICAgICAgICAgZGVwbG95VGltZTogcHJvcHMuZGVwbG95VGltZSxcbiAgICAgICAgfSk7XG5cbiAgICAgICAgdGhpcy5idWNrZXROYW1lID0gbG9jYXRpb24uYnVja2V0TmFtZTtcbiAgICAgICAgdGhpcy5vYmplY3RLZXkgPSBsb2NhdGlvbi5vYmplY3RLZXk7XG4gICAgICAgIHRoaXMuaHR0cFVybCA9IGxvY2F0aW9uLmh0dHBVcmw7XG4gICAgfVxuXG5cbiAgICAvKipcbiAgICAgKiBBZGRzIFJPUyB0ZW1wbGF0ZSBtZXRhZGF0YSB0byB0aGUgc3BlY2lmaWVkIHJlc291cmNlIHdpdGhcbiAgICAgKiBpbmZvcm1hdGlvbiB0aGF0IGluZGljYXRlcyB3aGljaCByZXNvdXJjZSBwcm9wZXJ0eSBpcyBtYXBwZWQgdG8gdGhpcyBsb2NhbFxuICAgICAqIGFzc2V0LlxuICAgICAqXG4gICAgICogQXNzZXQgbWV0YWRhdGEgd2lsbCBvbmx5IGJlIGluY2x1ZGVkIGlmIHRoZSBzdGFjayBpcyBzeW50aGVzaXplZCB3aXRoIHRoZVxuICAgICAqIFwicm9zOmNkazplbmFibGUtYXNzZXQtbWV0YWRhdGFcIiBjb250ZXh0IGtleSBkZWZpbmVkLCB3aGljaCBpcyB0aGUgZGVmYXVsdFxuICAgICAqIGJlaGF2aW9yIHdoZW4gc3ludGhlc2l6aW5nIHZpYSB0aGUgQ0RLIFRvb2xraXQuXG4gICAgICpcbiAgICAgKiBAcGFyYW0gcmVzb3VyY2UgVGhlIFJPUyByZXNvdXJjZSB3aGljaCBpcyB1c2luZyB0aGlzIGFzc2V0XG4gICAgICogQHBhcmFtIHJlc291cmNlUHJvcGVydHkgVGhlIHByb3BlcnR5IG5hbWUgd2hlcmUgdGhpcyBhc3NldCBpcyByZWZlcmVuY2VkXG4gICAgICovXG4gICAgcHVibGljIGFkZFJlc291cmNlTWV0YWRhdGEocmVzb3VyY2U6IHJvcy5Sb3NSZXNvdXJjZSwgcmVzb3VyY2VQcm9wZXJ0eTogc3RyaW5nKSB7XG4gICAgICAgIGlmICghdGhpcy5ub2RlLnRyeUdldENvbnRleHQoY3hhcGkuQVNTRVRfUkVTT1VSQ0VfTUVUQURBVEFfRU5BQkxFRF9DT05URVhUKSkge1xuICAgICAgICAgICAgcmV0dXJuOyAvLyBub3QgZW5hYmxlZFxuICAgICAgICB9XG4gICAgICAgIHJlc291cmNlLnJvc09wdGlvbnMubWV0YWRhdGEgPSByZXNvdXJjZS5yb3NPcHRpb25zLm1ldGFkYXRhIHx8IHsgfTtcbiAgICAgICAgcmVzb3VyY2Uucm9zT3B0aW9ucy5tZXRhZGF0YVtjeGFwaS5BU1NFVF9SRVNPVVJDRV9NRVRBREFUQV9QQVRIX0tFWV0gPSB0aGlzLmFzc2V0UGF0aDtcbiAgICAgICAgcmVzb3VyY2Uucm9zT3B0aW9ucy5tZXRhZGF0YVtjeGFwaS5BU1NFVF9SRVNPVVJDRV9NRVRBREFUQV9JU19CVU5ETEVEX0tFWV0gPSB0aGlzLmlzQnVuZGxlZDtcbiAgICAgICAgcmVzb3VyY2Uucm9zT3B0aW9ucy5tZXRhZGF0YVtjeGFwaS5BU1NFVF9SRVNPVVJDRV9NRVRBREFUQV9QUk9QRVJUWV9LRVldID0gcmVzb3VyY2VQcm9wZXJ0eTtcbiAgICB9XG59XG4iXX0=